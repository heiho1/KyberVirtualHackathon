import React from 'react';
import { Asset, Card, Modal, Text } from '@mydefi/ui';
import PropTypes from 'prop-types';
import { Solo, Networks } from '@dydxprotocol/solo';
import _ from 'lodash';
import numeral from 'numeral';
import Colors from './Colors';

const ICON =
  'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NiIgaGVpZ2h0PSIzMiIgdmlld0JveD0iMCAwIDY2IDMyIj4KICA8cGF0aCBmaWxsPSIjRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik00MC45NDA5MTAyLDAgTDI1LjU2MzY1NzcsMzIgTDI0LjQyNDc4MTEsMzIgTDM5LjgwMjAzMzUsMCBMNDAuOTQwOTEwMiwwIFogTTQyLjkyNzA1NywxMC41OTMxNCBDNDIuOTI3MDU3LDkuNjk3MDcwMzEgNDMuMjY4ODY2Niw4Ljk2ODM4NTEyIDQzLjk1MTE4Nyw4LjQwODA5MjI5IEM0NC42NTMxMTAyLDcuODQ4MDQ4NyA0NS41NTM5MzM0LDcuNTY3OTA3NzEgNDYuNjU0MTYzLDcuNTY3OTA3NzEgQzQ3LjM3NTQzNTgsNy41Njc5MDc3MSA0OC4wNjc4MjcyLDcuNjQyNTgzOCA0OC43MzEzMTU0LDcuNzkxOTI1MTQgQzQ5LjQxNDQxNzMsNy45NDEyNjY0OSA1MC4yMTA3NTUsOC4yMzA1NjQ1NCA1MS4xMjEzNzQxLDguNjYwNTU2MjEgTDUwLjYwOTU2NzcsOS42MTI3NDk1MSBDNDkuNzc1MDQ4Miw5LjIwMTc5ODAyIDQ5LjA2MzU3MTMsOC45MTI1MTA4IDQ4LjQ3NTY2NTQsOC43NDQzNjc2OCBDNDcuODg3MjQyMSw4LjU5NTAyNjM0IDQ3LjI4OTc5MzUsOC41MjAzNTAyNSA0Ni42ODMwNTUzLDguNTIwMzUwMjUgQzQ1Ljg2NzM2OCw4LjUyMDM1MDI1IDQ1LjIzMTQ3MzQsOC43MDcyODQzIDQ0Ljc3NjQxNyw5LjA4MDY0MzA4IEM0NC4zMDI1MjgzLDkuNDU0MDAxODYgNDQuMDY1MjA0Myw5Ljk0OTAyNDkgNDQuMDY1MjA0MywxMC41NjUxOTIgQzQ0LjA2NTIwNDMsMTEuMTYyODE3NSA0NC4yNTQ1NTA2LDExLjY3NjM4MjIgNDQuNjM0Mjc3OSwxMi4xMDU4NzU0IEM0NS4wMzI1ODQzLDEyLjUxNjgyNjkgNDUuOTE0NTY0MywxMy4xMTQyMDMxIDQ3LjI4MDUwNCwxMy44OTg1MTM0IEM0OC41MTM1ODMxLDE0LjYwODQwNzYgNDkuNDA0ODYzNiwxNS4yMTUxNzkzIDQ5Ljk1NTEwNSwxNS43MTkzMzc3IEM1MC41MjQxNzg2LDE2LjI0MjI5NzkgNTAuOTQxMzE3MywxNi44MDI1OTA4IDUxLjIwNzAxNjQsMTcuNDAwMjE2MiBDNTEuNDUzMTEyNywxNy45OTc4NDE3IDUxLjU3NjY4MzYsMTguNzE2ODgyMiA1MS41NzY2ODM2LDE5LjU1NzMyNjggQzUxLjU3NjY4MzYsMjEuMjE5NDE0NCA1MS4xMTIwODQ1LDIyLjUzNTgzMTEgNTAuMTgyODg2MywyMy41MDcwNzU0IEM0OS4yNTMxNzA4LDI0LjQ1OTUyODggNDcuOTUzMjgxNywyNC45MzU1MDA4IDQ2LjI4NDc0ODksMjQuOTM1NTAwOCBDNDQuNjcyNDU5OCwyNC45MzU1MDA4IDQzLjM4MjEwMjQsMjQuNDc4MDcwNSA0Mi40MTQ3MzMzLDIzLjU2MzQ2OTkgQzQxLjQ2NjE4NTUsMjIuNjY2NjQxNiA0MC45OTIwNDM3LDIxLjQ2MjQ5MzcgNDAuOTkyMDQzNywxOS45NDg5ODg5IEM0MC45OTIwNDM3LDE4LjUyOTcwOTcgNDEuMzk5ODkyOCwxNy4zNzIzMDA3IDQyLjIxNTg0NDIsMTYuNDc1OTgxOCBDNDMuMDEyMTkyOSwxNS41NjA4NzE4IDQ0LjI5MjQ3OTMsMTQuODc5MTY0IDQ2LjA1NjcxNDQsMTQuNDMwODc5OSBDNDQuODgwOTAyNSwxMy43NzczNjkzIDQ0LjA2NTIwNDMsMTMuMTYwOTQyIDQzLjYxMDE1ODksMTIuNTgxODU4MyBDNDMuMTU0MzIxLDExLjk4NDQ3MTIgNDIuOTI3MDU3LDExLjMyMTU2NTIgNDIuOTI3MDU3LDEwLjU5MzE0IFogTTU1LjYxOTE3Miw4LjcyNTc0NzI1IEw2MC4wMDIyOTMzLDE1LjU1OTQxNzUgTDY0LjQ0MjQ0NTYsOC43MjU3NDcyNSBMNjUuNjY2NjA5MSw4LjcyNTc0NzI1IEw2MC42Mjg4MzA5LDE2LjM3MTUwMjcgTDY2LjA2NDUxNjEsMjQuNzE3MzU3MSBMNjQuNzgzODUwMSwyNC43MTczNTcxIEw1OS45NzM5MjA5LDE3LjI2Nzg5MTkgTDU1LjA3ODMyNCwyNC43MTczNTcxIEw1My44MjY1NTg4LDI0LjcxNzM1NzEgTDU5LjI5MDg5MTYsMTYuMzcxNTAyNyBMNTQuMzM4NTE2OSw4LjcyNTc0NzI1IEw1NS42MTkxNzIsOC43MjU3NDcyNSBaIE00NC41Mzg2NzYsMTUuODMwMDYyNSBDNDMuOTY4OTU5NCwxNi4xMDk5MzUzIDQzLjUxMjg3MTEsMTYuNDQ1ODc1NyA0My4xNzExOTMyLDE2LjgzNzM4NTggQzQyLjgyODk5NzQsMTcuMjEwNjMyNiA0Mi41NzI1NTE3LDE3LjY1ODcxOTIgNDIuNDAxODQ1LDE4LjE4MDY0OTcgQzQyLjIxMjAyMDMsMTguNzAzMDg5IDQyLjExNjk4MTMsMTkuMjkwNzMzMSA0Mi4xMTY5ODEzLDE5Ljk0MzMzMjkgQzQyLjExNjk4MTMsMjEuMTU2Njg1MiA0Mi40OTY4ODQxLDIyLjEyNjQ1MzMgNDMuMjU2NDE0MywyMi44NTQ0MTI3IEM0NC4wMTU2OTExLDIzLjU4MTM1NDUgNDUuMDMyMTk1OSwyMy45NDU0NjQxIDQ2LjMwNDM3NTIsMjMuOTQ1NDY0MSBDNDcuNjE0NTE0OSwyMy45NDU0NjQxIDQ4LjYzMTAxOTgsMjMuNTcyNzI2MiA0OS4zNTIwODI2LDIyLjgyNTk5NDYgQzUwLjA3NDE3MDIsMjIuMDYwNzI4OSA1MC40MzQ3MDE2LDIwLjk2MDU0MDQgNTAuNDM0NzAxNiwxOS41MjQxNjI1IEM1MC40MzQ3MDE2LDE4LjU1Mzg4NTYgNTAuMTY4NjkxMywxNy43MTQ1Mzc4IDQ5LjYzNjk0NjMsMTcuMDA1NTk5NyBDNDkuMTI0NTYxOCwxNi4yOTY2NzIzIDQ4LjI0MTU3NDQsMTUuNjM0MTY2NyA0Ni45ODgyNDg4LDE1LjAxODM1MzQgQzQ1LjkwNTY0MDgsMTUuMjc5NzEzOCA0NS4wODk1Mzg5LDE1LjU1MDIwMDUgNDQuNTM4Njc2LDE1LjgzMDA2MjUgWiBNNy43Mzk0Njc4NCw3Ljc5MTkyNTE0IEM4LjQyMjMyMTkyLDcuOTQxMjY2NDkgOS4yMTg2ODk2Niw4LjIzMDU2NDU0IDEwLjEyOTU4MzcsOC42NjA1NTYyMSBMOS42MTcyNDc3Niw5LjYxMjc0OTUxIEM4Ljc4MjQ0NDEsOS4yMDE3OTgwMiA4LjA3MTIxNDM1LDguOTEyNTEwOCA3LjQ4MzI5NDM3LDguNzQ0MzY3NjggQzYuODk1Mzc0MzksOC41OTUwMjYzNCA2LjI5NzY0NzMsOC41MjAzNTAyNSA1LjY5MDY0MTQ0LDguNTIwMzUwMjUgQzQuODc1MTg3ODIsOC41MjAzNTAyNSA0LjIzOTU0MjEzLDguNzA3Mjg0MyAzLjc4NDQ3NDg1LDkuMDgwNjQzMDggQzMuMzA5ODA0MzYsOS40NTQwMDE4NiAzLjA3MzI0NTEsOS45NDkwMjQ5IDMuMDczMjQ1MSwxMC41NjUxOTIgQzMuMDczMjQ1MSwxMS4xNjI4MTc1IDMuMjYyNTk1OTgsMTEuNjc2MzgyMiAzLjY0MjMzMjM2LDEyLjEwNTg3NTQgQzQuMDQwMzg0MTUsMTIuNTE2ODI2OSA0LjkyMjY0OTM2LDEzLjExNDIwMzEgNi4yODgzNTc1MiwxMy44OTg1MTM0IEM3LjUyMTIxMjk4LDE0LjYwODQwNzYgOC40MTI3Njc5NywxNS4yMTUxNzkzIDguOTYyNTA1MTgsMTUuNzE5MzM3NyBDOS41MzE4NTY2MSwxNi4yNDIyOTc5IDkuOTQ5MjQ3NDMsMTYuODAyNTkwOCAxMC4yMTQ3MTA3LDE3LjQwMDIxNjIgQzEwLjQ2MTMzMDIsMTcuOTk3ODQxNyAxMC41ODQ2NCwxOC43MTY4ODIyIDEwLjU4NDY0LDE5LjU1NzMyNjggQzEwLjU4NDY0LDIxLjIxOTQxNDQgMTAuMTE5Nzc2NiwyMi41MzU4MzExIDkuMTkwNTU2MTUsMjMuNTA3MDc1NCBDOC4yNjEwODI1NSwyNC40NTk1Mjg4IDYuOTYxNDE1NSwyNC45MzU1MDA4IDUuMjkyMzI1NDksMjQuOTM1NTAwOCBDMy42Nzk5OTc4MSwyNC45MzU1MDA4IDIuMzkwMTI2ODYsMjQuNDc4MDcwNSAxLjQyMjcyMzY1LDIzLjU2MzQ2OTkgQzAuNDc0MTUzMTYyLDIyLjY2NjY0MTYgMCwyMS40NjI0OTM3IDAsMTkuOTQ4OTg4OSBDMCwxOC41Mjk3MDk3IDAuNDA3ODU4ODkzLDE3LjM3MjMwMDcgMS4yMjM1NjU2NywxNi40NzU5ODE4IEMyLjAyMDE4NjU3LDE1LjU2MDg3MTggMy4zMDA1MDM1NywxNC44NzkxNjQgNS4wNjQ3ODA4NCwxNC40MzA4Nzk5IEMzLjg4ODY3NjcxLDEzLjc3NzM2OTMgMy4wNzMyMjMwOSwxMy4xNjA5NDIgMi42MTc2NDk0OSwxMi41ODE4NTgzIEMyLjE2MjMyOTA2LDExLjk4NDQ4MjEgMS45MzQ3OTU0MiwxMS4zMjE1NzYgMS45MzQ3OTU0MiwxMC41OTMxNCBDMS45MzQ3OTU0Miw5LjY5NzA3MDMxIDIuMjc2MzQ5MDMsOC45NjgzODUxMiAyLjk1OTIwMzExLDguNDA4MDkyMjkgQzMuNjYxMTQzMDcsNy44NDgwNDg3IDQuNTYxOTg3ODUsNy41Njc5MDc3MSA1LjY2MjI0Mzc2LDcuNTY3OTA3NzEgQzYuMzgzMDQ5NDcsNy41Njc5MDc3MSA3LjA3NTQ0NjQ5LDcuNjQyNTcyOTYgNy43Mzk0Njc4NCw3Ljc5MTkyNTE0IFogTTMuNTYzMTU4ODksMTUuODMwMDYyNSBDMi45OTM0NDIzNiwxNi4xMDk5MzUzIDIuNTM3ODcxODgsMTYuNDQ1ODc1NyAyLjE5NTY3NjEzLDE2LjgzNzM4NTggQzEuODUzOTk4MjgsMTcuMjEwNjMyNiAxLjU5NzU1MjU2LDE3LjY1ODcxOTIgMS40MjY4NDU4NiwxOC4xODA2NDk3IEMxLjIzNjc2NzcyLDE4LjcwMzA4OSAxLjE0MTk4MjA5LDE5LjI5MDczMzEgMS4xNDE5ODIwOSwxOS45NDMzMzI5IEMxLjE0MTk4MjA5LDIxLjE1NjY4NTIgMS41MjE2MjA0OCwyMi4xMjY0NTMzIDIuMjgxNDE1MTUsMjIuODU0NDEyNyBDMy4wNDA2OTE5MywyMy41ODEzNTQ1IDQuMDU2OTQzMzMsMjMuOTQ1NDY0MSA1LjMyOTM3NiwyMy45NDU0NjQxIEM2LjYzOTUxNTc2LDIzLjk0NTQ2NDEgNy42NTU1MTM3MywyMy41NzI3MjYyIDguMzc3MDgzNDEsMjIuODI1OTk0NiBDOS4wOTg2NTMwOSwyMi4wNjA3Mjg5IDkuNDU5NzAyMzksMjAuOTYwNTQwNCA5LjQ1OTcwMjM5LDE5LjUyNDE2MjUgQzkuNDU5NzAyMzksMTguNTUzODg1NiA5LjE5MzY5MjE2LDE3LjcxNDUzNzggOC42NjE5NDcxOCwxNy4wMDU1OTk3IEM4LjE0OTMwOTE5LDE2LjI5NjY3MjMgNy4yNjYwNTczOSwxNS42MzQxNjY3IDYuMDEyOTk2MTcsMTUuMDE4MzUzNCBDNC45MzA2MzA2MiwxNS4yNzk3MTM4IDQuMTEzNzY4NDMsMTUuNTUwMjAwNSAzLjU2MzE1ODg5LDE1LjgzMDA2MjUgWiBNMjQuOTUzMTYwOSw4LjcyNTc0NzI1IEwxOS41NDMxNTUsMTguNTI4NDMxOCBMMTkuNTQzMTU1LDI0LjcxNzM1NzEgTDE4LjM3NTE4NTYsMjQuNzE3MzU3MSBMMTguMzc1MTg1NiwxOC42MTE5Nzc0IEwxMi45MzY3ODIyLDguNzI1NzQ3MjUgTDE0LjI0NjQ4NjIsOC43MjU3NDcyNSBMMTguOTczNjI4LDE3LjQ2MzkzMzEgTDIzLjcyODY0OTYsOC43MjU3NDcyNSBMMjQuOTUzMTYwOSw4LjcyNTc0NzI1IFoiLz4KPC9zdmc+Cg==';

function MarketList(markets) {
  const marks = markets.markets;
  if (marks && marks.length > 0) {
    const items = marks.map(market => (
      <div key={market.id}>
        <Text size="20px" color={Colors.textPrimary}>
          {market.name} ({market.symbol})
        </Text>
        <br />
        <Text size="20px" color={Colors.textSecondary}>
          Currency: {market.currency.symbol} <br />
          Supply Index: {market.supplyIndex} <br />
          Borrow Index: {market.borrowIndex} <br />
          Collateral Ratio: {market.collateralRatio} <br />
        </Text>
      </div>
    ));
    return <div>{items}</div>;
  }
  return <div>No markets available</div>;
}

class DyDxCard extends React.Component {
  constructor(props) {
    super(props);
    this.state = {
      showModal: false,
      markets: []
    };
  }

  componentDidMount = async () => {};

  componentDidUpdate = async prevProps => {
    if (!_.isEqual(this.props.selectedAddress, prevProps.selectedAddress)) {
      // eslint-disable-next-line react/no-did-update-set-state
      try {
        const marks = await this.getMarkets(this.props.selectedAddress);
        // eslint-disable-next-line react/no-did-update-set-state
        this.setState({
          markets: marks
        });
      } catch (err) {
        console.log(`Failure getting balances ${err}`);
      }
    }
  };

  toggleModal = () => {
    const isModal = this.state.showModal;
    this.setState({
      showModal: !isModal
    });
  };

  getMarkets = async selectedAddress => {
    if (selectedAddress) {
      const solo = new Solo(this.props.web3.currentProvider, Networks.MAINNET, {
        defaultAccount: selectedAddress
      });
      const { markets } = await solo.api.getMarkets();
      return markets;
    }
    return [];
  };

  selectedAddressExists = () => {
    return (
      typeof this.props.selectedAddress !== 'undefined' &&
      this.props.selectedAddress.length > 0
    );
  };

  render() {
    return (
      <Card title="DxDy" description="Decentralized Trading" onClick={this.toggleModal}>
        <Asset icon={ICON} size="30px" symbol="" />
        <Modal
          title="Uniswap Assets"
          visible={this.state.showModal}
          onClick={this.toggleModal}
          width="800px"
        >
          <MarketList markets={this.state.markets} />
        </Modal>
      </Card>
    );
  }
}

DyDxCard.propTypes = {
  selectedAddress: PropTypes.string.isRequired,
  // eslint-disable-next-line react/forbid-prop-types
  web3: PropTypes.object.isRequired
};

export default DyDxCard;
